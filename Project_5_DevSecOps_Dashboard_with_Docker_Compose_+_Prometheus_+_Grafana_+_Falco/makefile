# DevSecOps Dashboard with Docker Compose + Prometheus + Grafana + Falco
# Comprehensive Makefile for easy presentation and demonstration

# Docker Compose files
COMPOSE_FILE := docker-compose.yml
COMPOSE_FALCO_MOCK := docker-compose.falco-mock.yml
COMPOSE_MINIMAL := docker-compose.minimal.yml
COMPOSE_ATTACK := docker-compose.attack.yml

# Colors for output
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
MAGENTA := \033[35m
CYAN := \033[36m
WHITE := \033[37m
RESET := \033[0m

# Python command (use python3 for WSL/Linux)
PYTHON := $(shell which python3 2>/dev/null || which python 2>/dev/null || echo python3)

# Default target
.PHONY: help
help: ## Show this help message
	@echo "$(CYAN)ðŸ›¡ï¸  DevSecOps Dashboard - Make Commands$(RESET)"
	@echo "$(CYAN)================================================$(RESET)"
	@echo ""
	@echo "$(GREEN)ðŸ“‹ QUICK START:$(RESET)"
	@echo "  make demo          - Full demo presentation"
	@echo "  make start         - Start complete stack"
	@echo "  make mock          - Start with Mock Falco (WSL2 compatible)"
	@echo ""
	@echo "$(GREEN)ðŸš€ STACK MANAGEMENT:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-15s$(RESET) %s\n", $$1, $$2}'

.PHONY: check
check: ## ðŸ” Check system requirements and configuration
	@echo "$(CYAN)ðŸ” Checking system requirements...$(RESET)"
	@echo ""
	@echo "$(YELLOW)Python version:$(RESET)"
	@$(PYTHON) --version || echo "$(RED)âŒ Python not found$(RESET)"
	@echo ""
	@echo "$(YELLOW)Docker version:$(RESET)"
	@docker --version || echo "$(RED)âŒ Docker not found$(RESET)"
	@echo ""
	@echo "$(YELLOW)Docker Compose version:$(RESET)"
	@docker-compose --version || echo "$(RED)âŒ Docker Compose not found$(RESET)"
	@echo ""
	@echo "$(YELLOW)Validating compose files:$(RESET)"
	@$(MAKE) validate-compose
	@echo ""
	@echo "$(GREEN)âœ… System check completed$(RESET)"

.PHONY: demo
demo: ## ðŸŽ¬ Full presentation demo with all features
	@echo "$(MAGENTA)ðŸŽ¬ Starting DevSecOps Dashboard Demo$(RESET)"
	@echo "$(MAGENTA)=====================================$(RESET)"
	@echo ""
	@echo "$(YELLOW)Step 1: Starting complete monitoring stack...$(RESET)"
	@$(MAKE) start-mock
	@echo ""
	@echo "$(YELLOW)Step 2: Waiting for services to initialize...$(RESET)"
	@sleep 15
	@echo ""
	@echo "$(YELLOW)Step 3: Running security tests...$(RESET)"
	@$(MAKE) test-security
	@echo ""
	@echo "$(YELLOW)Step 4: Simulating attacks...$(RESET)"
	@$(MAKE) simulate-attacks
	@echo ""
	@echo "$(GREEN)âœ… Demo complete! Access points:$(RESET)"
	@$(MAKE) show-urls

.PHONY: start
start: ## ðŸš€ Start complete DevSecOps stack
	@echo "$(GREEN)ðŸš€ Starting DevSecOps Dashboard...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… Stack started!$(RESET)"
	@$(MAKE) show-urls

.PHONY: start-mock
start-mock: ## ðŸ›¡ï¸ Start stack with Mock Falco (WSL2 compatible)
	@echo "$(GREEN)ðŸ›¡ï¸  Starting DevSecOps Dashboard with Mock Falco...$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) up -d
	@echo "$(GREEN)âœ… Stack with Mock Falco started!$(RESET)"
	@$(MAKE) show-urls

.PHONY: mock
mock: start-mock ## ðŸ›¡ï¸ Alias for start-mock

.PHONY: start-minimal
start-minimal: ## âš¡ Start minimal stack (Prometheus + Grafana only)
	@echo "$(GREEN)âš¡ Starting minimal monitoring stack...$(RESET)"
	@docker-compose -f $(COMPOSE_MINIMAL) up -d
	@echo "$(GREEN)âœ… Minimal stack started!$(RESET)"
	@$(MAKE) show-urls

.PHONY: stop
stop: ## ðŸ›‘ Stop all services
	@echo "$(RED)ðŸ›‘ Stopping all services...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) down
	@docker-compose -f $(COMPOSE_FALCO_MOCK) down
	@docker-compose -f $(COMPOSE_MINIMAL) down
	@docker-compose -f $(COMPOSE_ATTACK) down
	@echo "$(RED)âœ… All services stopped$(RESET)"

.PHONY: restart
restart: stop start ## ðŸ”„ Restart complete stack

.PHONY: restart-mock
restart-mock: stop start-mock ## ðŸ”„ Restart with Mock Falco

.PHONY: build
build: ## ðŸ”¨ Build all custom containers
	@echo "$(BLUE)ðŸ”¨ Building custom containers...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) build
	@docker-compose -f $(COMPOSE_FALCO_MOCK) build
	@docker-compose -f $(COMPOSE_ATTACK) build
	@echo "$(BLUE)âœ… Build complete!$(RESET)"

.PHONY: logs
logs: ## ðŸ“‹ Show logs from all services
	@echo "$(CYAN)ðŸ“‹ Showing logs from all services...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) logs --tail=50

.PHONY: logs-falco
logs-falco: ## ðŸ›¡ï¸ Show Falco security logs
	@echo "$(CYAN)ðŸ›¡ï¸  Showing Falco security logs...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) logs falco --tail=50

.PHONY: logs-mock
logs-mock: ## ðŸ›¡ï¸ Show Mock Falco security logs
	@echo "$(CYAN)ðŸ›¡ï¸  Showing Mock Falco security logs...$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) logs falco-mock --tail=50

.PHONY: logs-follow
logs-follow: ## ðŸ“‹ Follow logs in real-time
	@echo "$(CYAN)ðŸ“‹ Following logs in real-time (Ctrl+C to stop)...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) logs -f

.PHONY: logs-follow-mock
logs-follow-mock: ## ðŸ›¡ï¸ Follow Mock Falco logs in real-time
	@echo "$(CYAN)ðŸ›¡ï¸  Following Mock Falco logs in real-time (Ctrl+C to stop)...$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) logs -f falco-mock

.PHONY: status
status: ## ðŸ“Š Show status of all services
	@echo "$(CYAN)ðŸ“Š Service Status:$(RESET)"
	@echo "$(CYAN)=================$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) ps 2>/dev/null || echo "Main stack not running"
	@echo ""
	@docker-compose -f $(COMPOSE_FALCO_MOCK) ps 2>/dev/null || echo "Mock Falco stack not running"

.PHONY: test-security
test-security: ## ðŸ§ª Run security tests
	@echo "$(YELLOW)ðŸ§ª Running security tests...$(RESET)"
	@$(PYTHON) test_falco.py
	@echo "$(GREEN)âœ… Security tests completed$(RESET)"

.PHONY: test-stack
test-stack: ## ðŸ§ª Test complete stack functionality
	@echo "$(YELLOW)ðŸ§ª Testing complete stack...$(RESET)"
	@$(PYTHON) test_stack.py
	@echo "$(GREEN)âœ… Stack tests completed$(RESET)"

.PHONY: test-grafana
test-grafana: ## ðŸ“Š Test Grafana dashboard configuration
	@echo "$(YELLOW)ðŸ“Š Testing Grafana dashboard...$(RESET)"
	@$(PYTHON) test_grafana_dashboard.py
	@echo "$(GREEN)âœ… Grafana tests completed$(RESET)"

.PHONY: simulate-attacks
simulate-attacks: ## âš”ï¸ Simulate security attacks
	@echo "$(RED)âš”ï¸  Simulating security attacks...$(RESET)"
	@docker-compose -f $(COMPOSE_ATTACK) up -d attack-simulator
	@echo "$(RED)âœ… Attack simulation started$(RESET)"

.PHONY: fix-falco
fix-falco: ## ðŸ”§ Fix Falco issues (auto-detect WSL2)
	@echo "$(YELLOW)ðŸ”§ Running Falco diagnostic and fix...$(RESET)"
	@$(PYTHON) fix_falco.py
	@echo "$(GREEN)âœ… Falco fix completed$(RESET)"

.PHONY: force-mock
force-mock: ## ðŸ›¡ï¸ Force switch to Mock Falco
	@echo "$(YELLOW)ðŸ›¡ï¸  Forcing switch to Mock Falco...$(RESET)"
	@$(PYTHON) fix_falco.py --mock
	@echo "$(GREEN)âœ… Switched to Mock Falco$(RESET)"

.PHONY: show-urls
show-urls: ## ðŸŒ Show all service URLs
	@echo ""
	@echo "$(GREEN)ðŸŒ Service Access Points:$(RESET)"
	@echo "$(GREEN)========================$(RESET)"
	@echo "$(CYAN)ðŸ“Š Grafana Dashboard:$(RESET)    http://localhost:3000 (admin/admin)"
	@echo "$(CYAN)ðŸ” Prometheus:$(RESET)           http://localhost:9090"
	@echo "$(CYAN)ðŸš€ Demo App:$(RESET)             http://localhost:8000"
	@echo "$(CYAN)ðŸ“± UI Dashboard:$(RESET)         http://localhost:8080"
	@echo "$(CYAN)ðŸ“‹ App Logs:$(RESET)             http://localhost:8000/logs"
	@echo "$(CYAN)ðŸ›¡ï¸  Security Events:$(RESET)     http://localhost:8000/security"
	@echo ""

.PHONY: open-dashboards
open-dashboards: ## ðŸŒ Open all dashboards in browser
	@echo "$(GREEN)ðŸŒ Opening dashboards in browser...$(RESET)"
	@$(PYTHON) -c "import webbrowser; webbrowser.open('http://localhost:3000')" 2>/dev/null || echo "Could not open browser"
	@$(PYTHON) -c "import webbrowser; webbrowser.open('http://localhost:9090')" 2>/dev/null || echo "Could not open browser"
	@$(PYTHON) -c "import webbrowser; webbrowser.open('http://localhost:8000')" 2>/dev/null || echo "Could not open browser"
	@$(PYTHON) -c "import webbrowser; webbrowser.open('http://localhost:8080')" 2>/dev/null || echo "Could not open browser"

.PHONY: clean
clean: ## ðŸ§¹ Clean up containers and volumes
	@echo "$(RED)ðŸ§¹ Cleaning up containers and volumes...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) down -v --remove-orphans
	@docker-compose -f $(COMPOSE_FALCO_MOCK) down -v --remove-orphans
	@docker-compose -f $(COMPOSE_MINIMAL) down -v --remove-orphans
	@docker-compose -f $(COMPOSE_ATTACK) down -v --remove-orphans
	@docker system prune -f
	@echo "$(RED)âœ… Cleanup completed$(RESET)"

.PHONY: reset
reset: clean build start-mock ## ðŸ”„ Complete reset and restart with Mock Falco

.PHONY: presentation
presentation: ## ðŸŽ¯ Presentation mode - optimized for demos
	@echo "$(MAGENTA)ðŸŽ¯ Starting Presentation Mode$(RESET)"
	@echo "$(MAGENTA)=============================$(RESET)"
	@$(MAKE) clean
	@$(MAKE) build
	@$(MAKE) start-mock
	@echo ""
	@echo "$(YELLOW)â³ Waiting for services to stabilize...$(RESET)"
	@sleep 20
	@echo ""
	@$(MAKE) test-security
	@$(MAKE) simulate-attacks
	@echo ""
	@echo "$(GREEN)ðŸŽ‰ Presentation ready!$(RESET)"
	@$(MAKE) show-urls
	@$(MAKE) open-dashboards

.PHONY: dev
dev: ## ðŸ‘¨â€ðŸ’» Development mode - start with live logs
	@$(MAKE) start-mock
	@echo "$(CYAN)ðŸ‘¨â€ðŸ’» Development mode - showing live logs...$(RESET)"
	@$(MAKE) logs-follow-mock

.PHONY: monitor
monitor: ## ðŸ“Š Monitor security events in real-time
	@echo "$(CYAN)ðŸ“Š Monitoring security events in real-time...$(RESET)"
	@echo "$(CYAN)Press Ctrl+C to stop monitoring$(RESET)"
	@echo ""
	@$(MAKE) logs-follow-mock

.PHONY: health
health: ## ðŸ¥ Check health of all services
	@echo "$(CYAN)ðŸ¥ Health Check:$(RESET)"
	@echo "$(CYAN)===============$(RESET)"
	@echo ""
	@echo "$(YELLOW)Checking Grafana...$(RESET)"
	@curl -s http://localhost:3000/api/health > /dev/null && echo "$(GREEN)âœ… Grafana: Healthy$(RESET)" || echo "$(RED)âŒ Grafana: Unhealthy$(RESET)"
	@echo "$(YELLOW)Checking Prometheus...$(RESET)"
	@curl -s http://localhost:9090/-/healthy > /dev/null && echo "$(GREEN)âœ… Prometheus: Healthy$(RESET)" || echo "$(RED)âŒ Prometheus: Unhealthy$(RESET)"
	@echo "$(YELLOW)Checking Demo App...$(RESET)"
	@curl -s http://localhost:8000/health > /dev/null && echo "$(GREEN)âœ… Demo App: Healthy$(RESET)" || echo "$(RED)âŒ Demo App: Unhealthy$(RESET)"
	@echo ""

.PHONY: backup
backup: ## ðŸ’¾ Backup Grafana dashboards and Prometheus data
	@echo "$(BLUE)ðŸ’¾ Creating backup...$(RESET)"
	@mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	@docker cp $$(docker-compose ps -q grafana):/var/lib/grafana backups/$(shell date +%Y%m%d_%H%M%S)/grafana 2>/dev/null || echo "Grafana not running"
	@docker cp $$(docker-compose ps -q prometheus):/prometheus backups/$(shell date +%Y%m%d_%H%M%S)/prometheus 2>/dev/null || echo "Prometheus not running"
	@echo "$(BLUE)âœ… Backup completed$(RESET)"

.PHONY: quick-demo
quick-demo: ## âš¡ Quick 2-minute demo
	@echo "$(MAGENTA)âš¡ Quick Demo (2 minutes)$(RESET)"
	@echo "$(MAGENTA)========================$(RESET)"
	@$(MAKE) start-mock
	@sleep 10
	@$(MAKE) test-security
	@echo "$(GREEN)âœ… Quick demo complete!$(RESET)"
	@$(MAKE) show-urls

.PHONY: logs-all
logs-all: ## ðŸ“‹ Show logs from all running stacks
	@echo "$(CYAN)ðŸ“‹ All Stack Logs:$(RESET)"
	@echo "$(CYAN)==================$(RESET)"
	@echo ""
	@echo "$(YELLOW)Main Stack Logs:$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) logs --tail=20 2>/dev/null || echo "Main stack not running"
	@echo ""
	@echo "$(YELLOW)Mock Falco Stack Logs:$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) logs --tail=20 2>/dev/null || echo "Mock Falco stack not running"

.PHONY: logs-security
logs-security: ## ðŸ›¡ï¸ Show only security-related logs
	@echo "$(CYAN)ðŸ›¡ï¸  Security Logs:$(RESET)"
	@echo "$(CYAN)==================$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) logs falco --tail=30 2>/dev/null || echo "Real Falco not running"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) logs falco-mock --tail=30 2>/dev/null || echo "Mock Falco not running"

.PHONY: shell-app
shell-app: ## ðŸš Open shell in demo app container
	@echo "$(CYAN)ðŸš Opening shell in demo app...$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) exec demo-app /bin/bash 2>/dev/null || \
	 docker-compose -f $(COMPOSE_FILE) exec demo-app /bin/bash 2>/dev/null || \
	 echo "$(RED)âŒ No demo app container running. Try: make start-mock$(RESET)"

.PHONY: shell-falco
shell-falco: ## ðŸš Open shell in Falco container
	@echo "$(CYAN)ðŸš Opening shell in Falco container...$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) exec falco-mock /bin/bash 2>/dev/null || \
	 docker-compose -f $(COMPOSE_FILE) exec falco /bin/bash 2>/dev/null || \
	 echo "$(RED)âŒ No Falco container running. Try: make start-mock$(RESET)"

.PHONY: generate-traffic
generate-traffic: ## ðŸš¦ Generate test traffic and security events
	@echo "$(YELLOW)ðŸš¦ Generating test traffic...$(RESET)"
	@for i in {1..5}; do \
		curl -s http://localhost:8000/health > /dev/null; \
		curl -s http://localhost:8000/metrics > /dev/null; \
		curl -s http://localhost:8000/logs > /dev/null; \
		sleep 2; \
	done
	@echo "$(GREEN)âœ… Test traffic generated$(RESET)"

.PHONY: stress-test
stress-test: ## ðŸ’ª Run stress test on the application
	@echo "$(RED)ðŸ’ª Running stress test...$(RESET)"
	@for i in {1..20}; do \
		curl -s http://localhost:8000/health & \
		curl -s http://localhost:8000/metrics & \
		curl -s http://localhost:8000/security & \
	done; wait
	@echo "$(GREEN)âœ… Stress test completed$(RESET)"

.PHONY: install-deps
install-deps: ## ðŸ“¦ Install Python dependencies for testing
	@echo "$(BLUE)ðŸ“¦ Installing Python dependencies...$(RESET)"
	@pip3 install docker requests prometheus-client 2>/dev/null || pip install docker requests prometheus-client
	@echo "$(GREEN)âœ… Dependencies installed$(RESET)"

.PHONY: validate-compose
validate-compose: ## âœ… Validate all Docker Compose files
	@echo "$(YELLOW)âœ… Validating Docker Compose files...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) config > /dev/null && echo "$(GREEN)âœ… Main compose file valid$(RESET)" || echo "$(RED)âŒ Main compose file invalid$(RESET)"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) config > /dev/null && echo "$(GREEN)âœ… Mock Falco compose file valid$(RESET)" || echo "$(RED)âŒ Mock Falco compose file invalid$(RESET)"
	@docker-compose -f $(COMPOSE_MINIMAL) config > /dev/null && echo "$(GREEN)âœ… Minimal compose file valid$(RESET)" || echo "$(RED)âŒ Minimal compose file invalid$(RESET)"
	@docker-compose -f $(COMPOSE_ATTACK) config > /dev/null && echo "$(GREEN)âœ… Attack compose file valid$(RESET)" || echo "$(RED)âŒ Attack compose file invalid$(RESET)"

.PHONY: ports
ports: ## ðŸ”Œ Show all exposed ports
	@echo "$(CYAN)ðŸ”Œ Exposed Ports:$(RESET)"
	@echo "$(CYAN)=================$(RESET)"
	@echo "$(GREEN)3000$(RESET) - Grafana Dashboard"
	@echo "$(GREEN)9090$(RESET) - Prometheus"
	@echo "$(GREEN)8000$(RESET) - Demo Application"
	@echo "$(GREEN)8080$(RESET) - UI Dashboard"
	@echo "$(GREEN)24224$(RESET) - Fluentd"
	@echo ""

.PHONY: troubleshoot
troubleshoot: ## ðŸ” Run troubleshooting diagnostics
	@echo "$(YELLOW)ðŸ” Running troubleshooting diagnostics...$(RESET)"
	@echo ""
	@$(MAKE) status
	@echo ""
	@$(MAKE) health
	@echo ""
	@$(MAKE) ports
	@echo ""
	@echo "$(YELLOW)Docker System Info:$(RESET)"
	@docker system df
	@echo ""
	@echo "$(YELLOW)Recent Docker Events:$(RESET)"
	@docker events --since 5m --until now 2>/dev/null | tail -10 || echo "No recent events"

.PHONY: update-images
update-images: ## ðŸ”„ Update all Docker images
	@echo "$(BLUE)ðŸ”„ Updating Docker images...$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) pull
	@docker-compose -f $(COMPOSE_FALCO_MOCK) pull
	@docker-compose -f $(COMPOSE_MINIMAL) pull
	@docker-compose -f $(COMPOSE_ATTACK) pull
	@echo "$(GREEN)âœ… Images updated$(RESET)"

.PHONY: security-scan
security-scan: ## ðŸ”’ Run security scan on containers
	@echo "$(RED)ðŸ”’ Running security scan...$(RESET)"
	@docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
		aquasec/trivy image --severity HIGH,CRITICAL \
		grafana/grafana:latest || echo "Trivy not available"
	@echo "$(GREEN)âœ… Security scan completed$(RESET)"

.PHONY: export-logs
export-logs: ## ðŸ“¤ Export all logs to files
	@echo "$(BLUE)ðŸ“¤ Exporting logs...$(RESET)"
	@mkdir -p logs/export/$(shell date +%Y%m%d_%H%M%S)
	@docker-compose -f $(COMPOSE_FILE) logs > logs/export/$(shell date +%Y%m%d_%H%M%S)/main-stack.log 2>/dev/null || echo "Main stack not running"
	@docker-compose -f $(COMPOSE_FALCO_MOCK) logs > logs/export/$(shell date +%Y%m%d_%H%M%S)/mock-falco.log 2>/dev/null || echo "Mock Falco not running"
	@echo "$(GREEN)âœ… Logs exported to logs/export/$(RESET)"

.PHONY: demo-script
demo-script: ## ðŸ“œ Show demo script commands
	@echo "$(MAGENTA)ðŸ“œ Demo Script Commands:$(RESET)"
	@echo "$(MAGENTA)========================$(RESET)"
	@echo ""
	@echo "$(GREEN)1. Start the stack:$(RESET)"
	@echo "   make start-mock"
	@echo ""
	@echo "$(GREEN)2. Open dashboards:$(RESET)"
	@echo "   make open-dashboards"
	@echo ""
	@echo "$(GREEN)3. Run security tests:$(RESET)"
	@echo "   make test-security"
	@echo ""
	@echo "$(GREEN)4. Monitor security events:$(RESET)"
	@echo "   make monitor"
	@echo ""
	@echo "$(GREEN)5. Simulate attacks:$(RESET)"
	@echo "   make simulate-attacks"
	@echo ""
	@echo "$(GREEN)6. Generate traffic:$(RESET)"
	@echo "   make generate-traffic"
	@echo ""
	@echo "$(GREEN)7. Check health:$(RESET)"
	@echo "   make health"
	@echo ""
	@echo "$(GREEN)8. Clean up:$(RESET)"
	@echo "   make stop"
